{{/* Hugo Blox: Contact */}}
{{/* Documentation: https://hugoblox.com/blocks/ */}}
{{/* License: https://github.com/HugoBlox/hugo-blox-builder/blob/main/LICENSE.md */}}

{{/* Initialise */}}
{{ $page := .wcPage }}
{{ $block := .wcBlock }}
{{ $autolink := default true $block.content.autolink }}
{{ $data := $block.content }}
{{ $required_fields := $data.required_fields | default slice }}


<section class="py-8 px-4 mx-auto max-w-screen-md sm:py-16 lg:px-6">
  {{ with $data.subtitle }}
    <h3 class="text-2xl font-semibold text-center mb-4">{{ . }}</h3>
  {{ end }}
  {{ with $block.content.text }}
    <p class="text-lg text-center mb-8">
      {{ . | emojify | $page.RenderString }}
    </p>
  {{ end }}
  <div class="mb-6">
    <form id="contact-form">
      <div class="mb-4">
        <label class="block mb-2" for="inputCompanyName"
          >{{ i18n "contact_company" }}{{ if in $required_fields "company" }}
            <span class="text-red-500">*</span>
          {{ end }}</label
        >
        <input
          type="text"
          name="company"
          class="w-full p-2 border border-gray-300 rounded"
          id="inputCompanyName"
          placeholder="{{ i18n "contact_company" | default "Company Name" }}"
          {{ if in $required_fields "company" }}required{{ end }}
        />
      </div>
      <div class="mb-4">
        <label class="block mb-2" for="inputFirstName"
          >{{ i18n "contact_first_name" }}{{ if in $required_fields "first_name" }}
            <span class="text-red-500">*</span>
          {{ end }}</label
        >
        <input
          type="text"
          name="first_name"
          class="w-full p-2 border border-gray-300 rounded"
          id="inputFirstName"
          placeholder="{{ i18n "contact_first_name" | default "First Name" }}"
          {{ if in $required_fields "first_name" }}required{{ end }}
        />
      </div>
      <div class="mb-4">
        <label class="block mb-2" for="inputLastName"
          >{{ i18n "contact_last_name" }}{{ if in $required_fields "last_name" }}
            <span class="text-red-500">*</span>
          {{ end }}</label
        >
        <input
          type="text"
          name="last_name"
          class="w-full p-2 border border-gray-300 rounded"
          id="inputLastName"
          placeholder="{{ i18n "contact_last_name" | default "Last Name" }}"
          {{ if in $required_fields "last_name" }}required{{ end }}
        />
      </div>
      <div class="mb-4">
        <label class="block mb-2" for="inputEmail"
          >{{ i18n "contact_email" }}{{ if in $required_fields "email" }}
            <span class="text-red-500">*</span>
          {{ end }}</label
        >
        <input
          type="email"
          name="email"
          class="w-full p-2 border border-gray-300 rounded"
          id="inputEmail"
          placeholder="{{ i18n "contact_email" | default "Email" }}"
          {{ if in $required_fields "email" }}required{{ end }}
        />
      </div>
      <div class="mb-4">
        <label class="block mb-2" for="inputPhoneNumber"
          >{{ i18n "contact_phone" }}</label
        >
        <input
          type="text"
          name="phone"
          class="w-full p-2 border border-gray-300 rounded"
          id="inputPhoneNumber"
          placeholder="{{ i18n "contact_phone" | default "Phone Number" }}"
        />
      </div>
      <div class="mb-4">
        <label class="block mb-2" for="inputWebsite"
          >{{ i18n "contact_website" }}</label
        >
        <input
          type="url"
          name="website"
          class="w-full p-2 border border-gray-300 rounded"
          id="inputWebsite"
          placeholder="{{ i18n "contact_website" | default "Website" }}"
        />
      </div>
      <div class="mb-4">
        <label class="block mb-2" for="inputCountry"
          >{{ i18n "contact_country" }}</label
        >
        <input
          type="text"
          name="country"
          class="w-full p-2 border border-gray-300 rounded"
          id="inputCountry"
          placeholder="{{ i18n "contact_country" | default "Country" }}"
        />
      </div>
      <div class="mb-4">
        <label class="block mb-2" for="inputCity"
          >{{ i18n "contact_city" }}</label
        >
        <input
          type="text"
          name="city"
          class="w-full p-2 border border-gray-300 rounded"
          id="inputCity"
          placeholder="{{ i18n "contact_city" | default "City" }}"
        />
      </div>
      <div class="mb-4">
        <label class="block mb-2" for="inputSubject"
          >{{ i18n "contact_subject" }}{{ if in $required_fields "subject" }}
            <span class="text-red-500">*</span>
          {{ end }}</label
        >
        <input
          type="text"
          name="subject"
          class="w-full p-2 border border-gray-300 rounded"
          id="inputSubject"
          placeholder="{{ i18n "contact_subject" | default "Subject" }}"
          {{ if in $required_fields "subject" }}required{{ end }}
        />
      </div>
      <div class="mb-4">
        <label class="block mb-2" for="inputMessage"
          >{{ i18n "contact_message" }}{{ if in $required_fields "message" }}
            <span class="text-red-500">*</span>
          {{ end }}</label
        >
        <textarea
          name="message"
          class="w-full p-2 border border-gray-300 rounded"
          id="inputMessage"
          rows="5"
          placeholder="{{ i18n "contact_message" | default "Message" }}"
          {{ if in $required_fields "message" }}required{{ end }}
        ></textarea>
      </div>
      <input
        type="hidden"
        name="g-recaptcha-response"
        id="g-recaptcha-response"
      />
      <button
        type="submit"
        class="w-full py-2 px-4 bg-indigo-500 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-opacity-75"
      >
        {{ i18n "contact_send" | default "Send" }}
      </button>
    </form>
  </div>

  <ul class="list-none">
    {{ if $data.email }}
      <li class="mb-2 flex items-center">
        {{ partial "functions/get_icon.html" (dict "name" "envelope" "pack" "hero" "attributes" "class=\"w-6 h-6 mr-2\"") }}
        <span id="person-email">
          {{- if $autolink }}
            <a href="mailto:{{ $data.email }}" class="text-blue-600"
              >{{ $data.email }}</a
            >
          {{ else }}
            {{ $data.email }}
          {{ end -}}
        </span>
      </li>
    {{ end }}

    {{ with $data.phone }}
      <li class="mb-2 flex items-center">
        {{ partial "functions/get_icon.html" (dict "name" "phone" "pack" "hero" "attributes" "class=\"w-6 h-6 mr-2\"") }}
        <span id="person-telephone">
          {{- if $autolink }}
            <a href="tel:{{ . }}" class="text-blue-600">{{ . }}</a>
          {{ else }}
            {{ . }}
          {{ end -}}
        </span>
      </li>
    {{ end }}

    {{ $addr_formatted := "" }}{{/* Scoping for maps. */}}
    {{ if $data.address.street | or $data.address.city | or $data.address.region | or $data.address.postcode | or $data.address.country }}
      {{ $addr_formatted = partial "functions/get_address" (dict "root" . "address" $data.address) }}
      <li class="mb-2 flex items-center">
        {{ partial "functions/get_icon.html" (dict "name" "map-pin" "pack" "hero" "attributes" "class=\"w-6 h-6 mr-2\"") }}
        <span id="person-address">{{ $addr_formatted }}</span>
      </li>
    {{ end }}

    {{ with $data.directions }}
      <li class="mb-2 flex items-center">
        {{ partial "functions/get_icon.html" (dict "name" "map" "pack" "hero" "attributes" "class=\"w-6 h-6 mr-2\"") }}
        <span>{{ . | markdownify | emojify }}</span>
      </li>
    {{ end }}

    {{ with $data.office_hours }}
      <li class="mb-2 flex items-center">
        {{ partial "functions/get_icon.html" (dict "name" "clock" "pack" "hero" "attributes" "class=\"w-6 h-6 mr-2\"") }}
        <span>
          {{- if not (reflect.IsSlice .) }}
            {{/* Support legacy string format. */}}
            {{- . | markdownify | emojify -}}
          {{ else }}
            {{- delimit . "<br>" | markdownify | emojify -}}
          {{ end -}}
        </span>
      </li>
    {{ end }}

    {{ with $data.appointment_url }}
      <li class="mb-2 flex items-center">
        {{ partial "functions/get_icon.html" (dict "name" "calendar" "pack" "hero" "attributes" "class=\"w-6 h-6 mr-2\"") }}
        <a href="{{ . }}" target="_blank" rel="noopener" class="text-blue-600"
          >{{ i18n "book_appointment" | default "Book an appointment" }}</a
        >
      </li>
    {{ end }}

    {{/* Contact links. */}}
    {{ range $data.contact_links }}
      <li class="mb-2 flex items-center">
        {{ partial "functions/get_icon.html" (dict "name" .icon "pack" .icon_pack "attributes" "class=\"w-6 h-6 mr-2 text-blue-600\"") }}
        <a
          href="{{ .link }}"
          target="_blank"
          rel="noopener"
          class="text-blue-600"
          >{{ .name }}</a
        >
      </li>
    {{ end }}
  </ul>

  <div id="map" class="w-full h-64 mt-4"></div>
  <div
    id="popup"
    class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 hidden"
  >
    <div
      id="popupContent"
      class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg text-center"
    >
      <p id="popupMessage" class="text-gray-700 dark:text-gray-200"></p>
    </div>
  </div>
</section>

<script>
  function initMap() {
    const mapOptions = {
      zoom: 15,
      center: { lat: 37.4275, lng: -122.1697 }
    };
    const map = new google.maps.Map(document.getElementById("map"), mapOptions);
    const marker = new google.maps.Marker({
      position: { lat: 37.4275, lng: -122.1697 },
      map: map,
    });
  }

  grecaptcha.ready(function() {
    grecaptcha.execute('6LfvTB0qAAAAAJKb-ayOnYI_fpA9ukwWIiU1ZL5X', {action: 'submit'}).then(function(token) {
      document.getElementById('g-recaptcha-response').value = token;
    });
  });

  function showPopup(message, isSuccess = true) {
  const popup = document.getElementById('popup');
  const popupMessage = document.getElementById('popupMessage');
  popupMessage.textContent = message;
  popupMessage.classList.remove('text-red-500', 'text-green-500');
  popupMessage.classList.add(isSuccess ? 'text-green-500' : 'text-red-500');
  popup.classList.remove('hidden');
  setTimeout(() => {
    popup.classList.add('hidden');
  }, 3000);
}

document.getElementById('contact-form').addEventListener('submit', function(event) {
  event.preventDefault();

  // Validate required fields
  const requiredFields = JSON.parse('{{ $required_fields | jsonify }}');
  let isValid = true;
  requiredFields.forEach(function(field) {
    const input = document.getElementsByName(field)[0];
    if (!input.value) {
      isValid = false;
      input.classList.add('border-red-500');
      const errorText = document.createElement('span');
      errorText.classList.add('text-red-500', 'text-sm');
      errorText.textContent = 'This field is required';
      if (!input.nextElementSibling) {
        input.parentNode.appendChild(errorText);
      }
    } else {
      input.classList.remove('border-red-500');
      if (input.nextElementSibling) {
        input.parentNode.removeChild(input.nextElementSibling);
      }
    }
  });

  if (!isValid) {
    showPopup('Please fill out all required fields.', false);
    return;
  }

  showPopup('Sending...', true);

  grecaptcha.execute('6LfvTB0qAAAAAJKb-ayOnYI_fpA9ukwWIiU1ZL5X', { action: 'submit' }).then(function(token) {
    document.getElementById('g-recaptcha-response').value = token;

    const form = document.getElementById('contact-form');
    const formData = new FormData(form);

    // Prepare data for Chatwoot API
    const data = {
      email: formData.get('email'),
      name: formData.get('first_name') + ' ' + formData.get('last_name'),
      phone_number: formData.get('phone'),
      avatar_url: '',  // Add avatar URL if needed
      custom_attributes: {
        company: formData.get('company'),
        website: formData.get('website'),
        country: formData.get('country'),
        city: formData.get('city'),
        subject: formData.get('subject'),
        message: formData.get('message')
      }
    };

    // Perform both fetch requests and wait for their results
    Promise.all([
      fetch('https://email.raise.systems/sendemail', {
        method: 'POST',
        body: formData,
        headers: {
          'Accept': 'application/json'
        }
      })
    ]).then(async ([emailResponse]) => {
      let emailSuccess = emailResponse.ok;

      if (!emailSuccess) {
        try {
          let emailError = await emailResponse.json();
          let errorMessage = emailError.message || emailError.error || 'There was an error sending your email.';
          showPopup(`Email Error: ${errorMessage}`, false);
        } catch (e) {
          showPopup('Email Error: There was an error sending your email.', false);
        }
      }

      if (emailSuccess) {
        form.reset();
        const inputs = form.querySelectorAll('input, textarea, button');
        inputs.forEach(input => input.disabled = true);
        showPopup('Message sent successfully!', true);
      }
    }).catch(error => {
      console.error('Form submission error:', error);
      showPopup(`Error: ${error.message || 'There was an error sending your message.'}`, false);
    });
  });
});

</script>
